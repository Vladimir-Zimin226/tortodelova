# tortodelova — сервис для генерации дизайнов тортов

tortodelova — это веб-сервис, призванный облегчить жизнь домашним кондитерам и малым кондитерским.  
Сервис помогает придумывать и визуализировать красивые дизайны тортов с помощью ИИ:  
пользователь описывает идею торта на русском языке, а система генерирует изображение готового дизайна.

---

## Зачем нужен сервис

- Домашним кондитерам — быстро подбирать визуальные идеи для заказчиков.
- Небольшим кондитерским — генерировать варианты оформления к праздникам и акциям.
- Начинающим — пробовать разные стили декора (минимализм, детские торты, свадебные, тематические и т.д.).
- Заказчикам — проще объяснить свои пожелания кондитеру через готовую картинку.

---

## Текущий статус

Проект **в активной разработке**.  
Сейчас заложены основы:

- Структура проекта (backend / frontend / deploy).
- Базовая точка входа FastAPI (`backend/app/main.py`).
- ORM-модели для PostgreSQL:
  - `User`
  - `Transaction`
  - `PredictionRequest`

Далее планируется развитие функционала бэкенда, фронтенда и интеграция с локальными ML-моделями.

---

## Архитектура и стек

**Backend:**

- Python 3
- FastAPI (REST API)
- SQLAlchemy 2.x (ORM)
- PostgreSQL (хранение пользователей, транзакций и истории запросов)
- MinIO (S3-совместимое хранилище для изображений)
- JWT-аутентификация
- Docker / docker-compose (локальный запуск и изоляция сервисов)

**Frontend:**

- JavaScript
- React + Vite (SPA для личного кабинета пользователя)

**Инфраструктура:**

- `docker-compose.yml` поднимает:
  - backend (FastAPI + Uvicorn)
  - frontend (Vite dev/prod)
  - db (PostgreSQL)
  - minio (S3-хранилище)

---

## Модели данных

В базе данных планируется три ключевых сущности:

- **User**
  - `id`
  - `email`
  - `hashed_password`
  - `role` (`user` / `admin`)
  - `balance_credits` — баланс условных кредитов

- **Transaction**
  - `id`
  - `user_id`
  - `amount`
  - `type` (`debit` / `credit`)
  - `description`
  - `created_at`

- **PredictionRequest**
  - `id`
  - `user_id`
  - `prompt_ru`
  - `prompt_en`
  - `s3_key`
  - `public_url`
  - `credits_spent`
  - `status` (`pending` / `success` / `failed`)
  - `created_at`

Это позволяет:

- хранить историю финансовых операций (пополнения/списания кредитов);
- хранить историю всех запросов на генерацию изображений с привязкой к пользователю.

---

## План по использованию ИИ-моделей

Проект ориентирован на **локальный запуск моделей** (без внешних API):

1. **Перевод промпта (RU → EN)**  
   - Модель: `Helsinki-NLP/opus-mt-ru-en`  
   - Задача:
     - преобразовать описания тортов на русском языке в английский промпт,
       более удобный для генерации изображения.
   - Пример:
     - Ввод пользователя: _«Нежный торт с ягодами, в пастельных тонах, для девочки 5 лет»_
     - Перевод: _"Soft pastel-colored cake with berries for a 5-year-old girl"_

2. **Генерация изображений**  
   - Модель: **DreamShaper v8 (Stable Diffusion 1.5)**  
   - Задача:
     - по английскому промпту сгенерировать изображение дизайна торта
       (композиция, украшения, цветовая гамма, стиль).
   - Требования:
     - модель запускается локально (через отдельный сервис или внутри backend-сервиса);
     - ограничение размера/количества итераций с учётом производительности.

3. **Оркестрация процесса** (backend сервис `ml_service`):
   - Принять русский промпт от пользователя.
   - Перевести на английский.
   - Подготовить параметры генерации (seed, guidance, размеры и т.п.).
   - Запустить генерацию изображения.
   - Сохранить результат в MinIO.
   - Создать запись `PredictionRequest` в БД.
   - Корректно списать кредиты (только после успешного сохранения в MinIO).

---

## Хранение файлов (MinIO/S3)

Все сгенерированные изображения **не хранятся** на локальной файловой системе.  
Используется S3-совместимое хранилище MinIO.

План:

- В `.env` задаются переменные:

  ```env
  S3_ENDPOINT=http://minio:9000
  S3_PUBLIC_ENDPOINT=http://localhost:9000
  S3_REGION=ru-7
  S3_BUCKET=tortodelova
  S3_ACCESS_KEY=tortodelova_s3
  S3_SECRET_KEY=super-secret
  S3_ADDRESSING_STYLE=path
  ```

- При успешной генерации изображение загружается в MinIO в бакет `tortodelova`.
- В БД сохраняются только:
  - `s3_key` — уникальный ключ объекта;
  - `public_url` — публичная ссылка вида:

    ```text
    {S3_PUBLIC_ENDPOINT}/{S3_BUCKET}/{s3_key}
    ```

- Списание кредитов происходит **только после**:
  - успешной генерации;
  - успешной загрузки файла в MinIO;
  - успешной фиксации транзакции в БД.

Все операции, связанные с генерацией и списанием, будут оборачиваться в транзакции БД для обеспечения целостности данных.

---

## Планируемый функционал

### Для пользователя

- Регистрация и авторизация (JWT).
- Просмотр и пополнение баланса кредитов.
- Отправка промптов на русском языке для генерации дизайнов тортов.
- Получение сгенерированных изображений.
- История:
  - всех запросов на генерацию;
  - всех транзакций по балансу.
- Удобный интерфейс:
  - галерея сохранённых дизайнов;
  - фильтры по дате, стилю, расходу кредитов.

### Для администратора

- Просмотр пользователей и их балансов.
- Ручное пополнение/коррекция баланса (бонусы, компенсации).
- Просмотр журнала транзакций.
- Мониторинг нагрузки и количества генераций.

---

## Ближайший roadmap по разработке

1. **Бэкенд**
   - Настроить подключение к PostgreSQL и миграции (Alembic).
   - Реализовать:
     - регистрацию и логин (JWT);
     - эндпоинты для получения и пополнения баланса;
     - эндпоинт для создания запроса на генерацию изображения;
     - эндпоинты для истории транзакций и предсказаний.
   - Вынести в отдельные сервисы:
     - `ml_service` (перевод + генерация);
     - `storage_service` (работа с MinIO).

2. **Фронтенд**
   - Базовый личный кабинет:
     - форма логина/регистрации;
     - отображение текущего баланса и истории запросов;
     - форма отправки промпта на генерацию;
     - галерея изображений.
   - Отдельная админ-панель (по роли `admin`).

3. **Инфраструктура**
   - Полная конфигурация `docker-compose` со всеми зависимостями.
   - Скрипты/инструкции для локального запуска проекта.

---

Проект развивается итеративно: по мере добавления функционала README будет дополняться инструкциями по запуску, описанием API и примерами запросов.
