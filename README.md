# tortodelova — сервис для генерации дизайнов тортов

**tortodelova** — веб‑сервис, который помогает кондитерам и небольшим кондитерским быстро придумывать и визуализировать дизайн тортов с помощью ИИ.  
Пользователь описывает идею торта **на русском**, сервис переводит промпт **RU → EN** и генерирует изображение дизайна.

---

## Кому нужен сервис

- Домашним кондитерам — быстро подбирать визуальные идеи для заказчиков.
- Небольшим кондитерским — генерировать варианты оформления к праздникам и акциям.
- Начинающим — пробовать разные стили декора (минимализм, детские торты, свадебные, тематические и т.д.).
- Заказчикам — проще объяснить свои пожелания кондитеру через готовую картинку.

---

## Запуск проекта

Ниже — рекомендуемый порядок запуска **локально через Docker**.

### 1) Предварительные требования

- **Docker** и **Docker Compose** (проверка: `docker --version`, `docker compose version`)
- Достаточно места на диске: модели и кеши могут занимать **несколько гигабайт**
- (Опционально) GPU: генерация изображений на CPU обычно **заметно медленнее**

### 2) Скачайте ML‑модели

Перед первым запуском скачайте модели скриптом из корня репозитория:

```bash
python download_models.py
```

Скрипт нужен один раз (или при очистке каталога моделей). Он скачивает:
- переводчик **Helsinki-NLP/opus-mt-ru-en**
- генеративную модель **DreamShaper v8 (SD 1.5)**

> Если вы запускаете проект в окружении без локального Python — скачайте модели на хосте, а затем запускайте Docker.

### 3) Поднимите сервисы через Docker Compose

Compose-файлы лежат в каталоге `deploy/`:

```bash
cd deploy
docker compose up --build
```

После старта:
- API (FastAPI) доступен на `http://localhost:8000`  
  - Swagger: `http://localhost:8000/api/docs`
  - Health-check: `http://localhost:8000/health`
- UI (фронтенд) — через nginx/публичный порт из compose (зависит от конфигурации проекта)

Остановить сервисы:

```bash
docker compose down
```

Посмотреть логи:

```bash
docker compose logs -f app
docker compose logs -f ml_worker
docker compose logs -f db_worker
```

---

## Что умеет сервис

### Пользовательские сценарии

- Регистрация и логин по JWT:
  - `POST /api/auth/register`
  - `POST /api/auth/login`
- Баланс в “кредитах”:
  - просмотр баланса
  - пополнение баланса (упрощённо, без эквайринга)
  - история транзакций (пополнения/списания)
- Генерация изображений дизайна торта по промпту на русском:
  - постановка задачи в очередь (асинхронно через Celery)
  - хранение результата в MinIO (S3)
  - история сгенерированных изображений
- Получение изображения:
  - просмотр (через редирект на presigned URL)
  - скачивание файла через бэкенд.

### Демо‑режим

- Одна бесплатная генерация без регистрации (через демо‑пользователя)
- Просмотр демо‑результата и “забор” (claim) в историю после регистрации (по task_id)

### Админ‑возможности (роль `admin`)

- Просмотр пользователей, транзакций и предиктов
- Ручная корректировка баланса
- Удаление пользователей (по правилам проекта)

---

## Архитектура и стек

### Backend

- Python + FastAPI (REST API)
- SQLAlchemy 2.x (async) + PostgreSQL
- JWT‑аутентификация (HS256)
- MinIO (S3‑совместимое хранилище изображений)
- Celery + RabbitMQ:
  - `ml_worker` — перевод + генерация изображений
  - `db_worker` — атомарные операции с БД (списание кредитов, запись результата)

### Frontend

- React + Vite (SPA личного кабинета)
- REST‑клиент с автоматической подстановкой JWT

### Docker‑инфраструктура

`docker-compose` поднимает (типовой набор):
- `app` — FastAPI backend
- `ml_worker` — Celery worker (ML)
- `db_worker` — Celery worker (DB)
- `postgres`, `rabbitmq`, `minio`, `nginx` (reverse proxy)

---

## Хранение изображений (MinIO/S3)

- Изображения хранятся **только** в MinIO
- В БД сохраняются:
  - `s3_key` объекта
  - `public_url` (для упрощённого MVP/публичного чтения)
- Для более безопасного режима предусмотрена выдача через presigned URL (эндпоинт `/image`)
- Для гарантированной загрузки пользователем доступен эндпоинт `/download` (стриминг через бэкенд)

---

## Текущий статус

Проект **в активной разработке**.  
Уже реализованы: личный кабинет, JWT‑аутентификация, кредиты/транзакции, асинхронная генерация (Celery), хранение в MinIO, демо‑режим и базовая админка.  
README будет дополняться по мере развития функционала и стабилизации конфигурации запуска.
